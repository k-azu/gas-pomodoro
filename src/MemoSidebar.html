<script>
  var MemoSidebar = (function () {
    var memos = []; // MemoMetadata[]
    var memoTags = []; // MemoTag[]
    var activeId = null;
    var saveDebounce = null;
    var SAVE_DELAY = 30000; // 30s — localStorage handles instant persistence, server is backup
    var sidebarBusy = false; // true while create/delete server call in-flight
    var activeTagFilter = null; // null=all, string=specific tag name
    var tagFilterDropdownOpen = false;
    var tagFilterDropdownEl = null;
    var dragState = null; // { id, el, clone, placeholder, listEl, startY, offsetY, currentIndex }
    var pendingOrder = null; // 保存待ちの最新ID配列
    var savingOrder = false; // サーバー送信中フラグ

    function ls(key) {
      try { return localStorage.getItem(key) || ""; } catch (e) { return ""; }
    }
    function lsSet(key, val) {
      try { localStorage.setItem(key, val); } catch (e) {}
    }
    function lsRemove(key) {
      try { localStorage.removeItem(key); } catch (e) {}
    }

    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        var r = (Math.random() * 16) | 0;
        return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
      });
    }

    var MEMO_CACHE_PREFIX = "gas_pomodoro_memo_";
    var TS_PREFIX = "gas_pomodoro_memo_ts_";
    var SYNCED_PREFIX = "gas_pomodoro_memo_synced_";

    function setLocalTs(id, ts) { lsSet(TS_PREFIX + id, ts); }
    function getLocalTs(id) { return ls(TS_PREFIX + id); }
    function setSynced(id, ts) { lsSet(SYNCED_PREFIX + id, ts); }
    function getSynced(id) { return ls(SYNCED_PREFIX + id); }
    function hasUnsyncedEdits(id) {
      var localTs = getLocalTs(id);
      var syncedTs = getSynced(id);
      return !!(localTs && syncedTs && localTs > syncedTs);
    }

    function cleanOrphanedCache() {
      try {
        var validIds = {};
        memos.forEach(function (m) { validIds[m.id] = true; });
        var keysToRemove = [];
        var prefixes = [MEMO_CACHE_PREFIX, TS_PREFIX, SYNCED_PREFIX];
        for (var i = 0; i < localStorage.length; i++) {
          var key = localStorage.key(i);
          if (!key) continue;
          for (var p = 0; p < prefixes.length; p++) {
            if (key.indexOf(prefixes[p]) === 0) {
              var id = key.slice(prefixes[p].length);
              if (id && id !== "active" && id !== "sidebar_collapsed" && !validIds[id]) {
                keysToRemove.push(key);
              }
              break;
            }
          }
        }
        keysToRemove.forEach(function (k) { localStorage.removeItem(k); });
      } catch (e) {}
    }

    // =========================================================
    // Init
    // =========================================================
    function init(serverMemos, serverMemoTags) {
      memos = serverMemos || [];
      memoTags = serverMemoTags || [];

      // Clean up orphaned localStorage caches
      cleanOrphanedCache();

      render();

      // Flush to server on tab close / hide
      window.addEventListener("beforeunload", flushSave);
      document.addEventListener("visibilitychange", function () {
        if (document.visibilityState === "hidden") flushSave();
      });
    }

    function initAfterEditorMount() {
      // Migration: old single memo -> first multi-memo
      var oldMemo = ls("gas_pomodoro_memo");
      if (memos.length === 0 && oldMemo) {
        var migrationId = generateUUID();
        serverCall("saveMemo", { id: migrationId, name: "メモ", content: oldMemo, tags: [] })
          .then(function (result) {
            if (result.success) {
              lsRemove("gas_pomodoro_memo");
              lsSet("gas_pomodoro_memo_" + result.id, oldMemo);
              memos.push({
                id: result.id,
                name: "メモ",
                tags: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                sortOrder: 1,
                isActive: true,
              });
              activeId = result.id;
              lsSet("gas_pomodoro_memo_active", activeId);
              render();
            }
          })
          .catch(function (err) {
            console.error("Memo migration failed:", err);
          });
        return;
      }

      // Normal flow: determine active memo
      var savedActiveId = ls("gas_pomodoro_memo_active");
      if (savedActiveId && memos.some(function (m) { return m.id === savedActiveId; })) {
        activeId = savedActiveId;
      } else if (memos.length > 0) {
        activeId = memos[0].id;
      }

      if (activeId) {
        lsSet("gas_pomodoro_memo_active", activeId);
        loadMemoContent(activeId);
        render();
      }
    }

    // =========================================================
    // Memo content loading
    // =========================================================

    function setEditorLoading(on) {
      var area = document.querySelector(".memo-editor-area");
      if (!area) return;
      var overlay = area.querySelector(".memo-editor-loading-overlay");
      if (on) {
        if (overlay) return;
        overlay = document.createElement("div");
        overlay.className = "memo-editor-loading-overlay";
        overlay.innerHTML = '<div class="memo-editor-loading-spinner"></div>';
        area.appendChild(overlay);
      } else {
        if (overlay) overlay.remove();
      }
    }

    function loadMemoContent(id) {
      var cached = ls("gas_pomodoro_memo_" + id);

      if (cached) {
        // Cache exists: show immediately in readOnly mode (preserves per-doc undo history)
        MemoEditor.switchDocument(id, cached);
        MemoEditor.setEditable(false);
      } else {
        // No cache: show loading overlay
        MemoEditor.switchDocument(id, "");
        setEditorLoading(true);
      }

      serverCall("getMemoContent", id)
        .then(function (result) {
          if (activeId !== id) return;

          var serverContent = (result && result.content) || "";
          var serverTs = (result && result.updatedAt) || "";
          var localContent = ls("gas_pomodoro_memo_" + id);
          var localTs = getLocalTs(id);
          var syncedTs = getSynced(id);

          var hasLocalEdits = !!(localTs && syncedTs && localTs > syncedTs);
          var serverIsNewer = !!(serverTs && serverTs !== syncedTs);

          if (!syncedTs) {
            // First load or migration: no synced timestamp yet
            if (localTs && localContent) {
              // Has local edits from before migration — push local content
              MemoEditor.setValue(localContent);
              setSynced(id, localTs);
              syncToServer(id);
            } else {
              // Use server content
              MemoEditor.setValue(serverContent);
              lsSet("gas_pomodoro_memo_" + id, serverContent);
              if (serverTs) setSynced(id, serverTs);
            }
          } else if (hasLocalEdits && serverIsNewer) {
            // Conflict: both local and server have changed
            if (confirm("このメモは別の場所で更新されています。\nサーバーの内容を読み込みますか？\n\nOK → サーバーの内容で上書き\nキャンセル → 現在の内容を保持")) {
              // User chose server version
              MemoEditor.setValue(serverContent);
              lsSet("gas_pomodoro_memo_" + id, serverContent);
              setLocalTs(id, serverTs);
              setSynced(id, serverTs);
            } else {
              // User chose to keep local version — push to server
              MemoEditor.setValue(localContent);
              syncToServer(id);
            }
          } else if (hasLocalEdits && !serverIsNewer) {
            // Only local has changed — push to server
            MemoEditor.setValue(localContent);
            syncToServer(id);
          } else {
            // Server is newer or both unchanged — use server content
            MemoEditor.setValue(serverContent);
            lsSet("gas_pomodoro_memo_" + id, serverContent);
            if (serverTs) {
              setLocalTs(id, serverTs);
              setSynced(id, serverTs);
            }
          }
        })
        .catch(function (err) {
          console.error("Failed to load memo content:", err);
          // If no cache was shown, show empty fallback
          if (!cached) MemoEditor.setValue("");
        })
        .finally(function () {
          if (activeId === id) {
            MemoEditor.setEditable(true);
            setEditorLoading(false);
          }
        });
    }

    // =========================================================
    // Save current memo
    // =========================================================

    // Core: write editor content to localStorage and set localTs if changed.
    // Returns true if content was actually different.
    function persistToLocal() {
      if (!activeId) return false;
      var content = MemoEditor.getValue();
      var existing = ls("gas_pomodoro_memo_" + activeId);
      if (content === existing) return false;
      lsSet("gas_pomodoro_memo_" + activeId, content);
      setLocalTs(activeId, new Date().toISOString());
      return true;
    }

    function saveCurrent() {
      if (!persistToLocal()) return;

      // Debounced server save (30s)
      if (saveDebounce) clearTimeout(saveDebounce);
      saveDebounce = setTimeout(function () {
        saveDebounce = null;
        if (activeId && hasUnsyncedEdits(activeId)) {
          syncToServer(activeId);
        }
      }, SAVE_DELAY);
    }

    function syncToServer(id) {
      if (!id) return;
      var capturedTs = getLocalTs(id);
      if (!capturedTs) return;
      var content = ls("gas_pomodoro_memo_" + id);
      serverCall("saveMemoContent", id, content, capturedTs)
        .then(function () {
          setSynced(id, capturedTs);
        })
        .catch(function (err) {
          console.error("Failed to save memo to server:", err);
        });
    }

    // =========================================================
    // Select memo
    // =========================================================
    function selectMemo(id) {
      if (sidebarBusy) return;
      if (id === activeId) return;

      // Save current before switching
      if (activeId) {
        flushSave();
      }

      activeId = id;
      lsSet("gas_pomodoro_memo_active", id);
      loadMemoContent(id);
      render();
    }

    function flushSave() {
      if (saveDebounce) {
        clearTimeout(saveDebounce);
        saveDebounce = null;
      }
      persistToLocal();
      if (activeId && hasUnsyncedEdits(activeId)) {
        syncToServer(activeId);
      }
    }

    // =========================================================
    // Create memo
    // =========================================================
    function createMemo() {
      if (sidebarBusy) return;
      sidebarBusy = true;
      setSidebarLoading(true);

      // Save current first
      flushSave();

      var id = generateUUID();
      var name = "新しいメモ";
      serverCall("saveMemo", { id: id, name: name, content: "", tags: [] })
        .then(function (result) {
          if (result.success) {
            var now = new Date().toISOString();
            memos.push({
              id: result.id,
              name: name,
              tags: [],
              createdAt: now,
              updatedAt: now,
              sortOrder: memos.length + 1,
              isActive: true,
            });
            activeId = result.id;
            lsSet("gas_pomodoro_memo_active", activeId);
            lsSet("gas_pomodoro_memo_" + activeId, "");
            setLocalTs(activeId, now);
            setSynced(activeId, now);
            MemoEditor.switchDocument(result.id, "");
            render();
            // Start inline rename
            setTimeout(function () { startRename(result.id); }, 100);
          }
        })
        .catch(function (err) {
          console.error("Failed to create memo:", err);
        })
        .finally(function () {
          sidebarBusy = false;
          setSidebarLoading(false);
        });
    }

    function setSidebarLoading(on) {
      var btn = document.querySelector(".memo-new-btn");
      if (btn) {
        if (on) {
          btn.disabled = true;
          btn.textContent = "";
          btn.classList.add("is-loading");
        } else {
          btn.disabled = false;
          btn.textContent = "+";
          btn.classList.remove("is-loading");
        }
      }
      var list = document.querySelector(".memo-sidebar-list");
      if (list) {
        if (on) list.classList.add("is-busy");
        else list.classList.remove("is-busy");
      }
    }

    // =========================================================
    // Delete memo
    // =========================================================
    function deleteMemoDo(id) {
      if (sidebarBusy) return;
      var memo = memos.find(function (m) { return m.id === id; });
      if (!memo) return;
      if (!confirm("「" + memo.name + "」を削除しますか？")) return;

      sidebarBusy = true;
      setSidebarLoading(true);
      serverCall("deleteMemo", id)
        .then(function (result) {
          if (result.success) {
            memos = memos.filter(function (m) { return m.id !== id; });
            lsRemove("gas_pomodoro_memo_" + id);
            lsRemove(TS_PREFIX + id);
            lsRemove(SYNCED_PREFIX + id);
            if (activeId === id) {
              activeId = memos.length > 0 ? memos[0].id : null;
              if (activeId) {
                lsSet("gas_pomodoro_memo_active", activeId);
                loadMemoContent(activeId);
              } else {
                lsRemove("gas_pomodoro_memo_active");
                MemoEditor.setValue("");
              }
            }
            render();
          }
        })
        .catch(function (err) {
          console.error("Failed to delete memo:", err);
        })
        .finally(function () {
          sidebarBusy = false;
          setSidebarLoading(false);
        });
    }

    // =========================================================
    // Rename memo (inline)
    // =========================================================
    function startRename(id) {
      if (sidebarBusy) return;
      var el = document.querySelector('.memo-sidebar-item[data-id="' + id + '"] .memo-item-name');
      if (!el) return;

      var memo = memos.find(function (m) { return m.id === id; });
      if (!memo) return;

      var input = document.createElement("input");
      input.type = "text";
      input.className = "memo-rename-input";
      input.value = memo.name;

      function finishRename() {
        var newName = input.value.trim() || memo.name;
        if (newName !== memo.name) {
          memo.name = newName;
          serverCall("renameMemo", id, newName).catch(function () {});
        }
        render();
      }

      input.addEventListener("blur", finishRename);
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") { e.preventDefault(); input.blur(); }
        if (e.key === "Escape") { input.value = memo.name; input.blur(); }
      });

      el.textContent = "";
      el.appendChild(input);
      input.focus();
      input.select();
    }

    function startToolbarRename(nameEl) {
      if (!activeId) return;
      var memo = memos.find(function (m) { return m.id === activeId; });
      if (!memo) return;

      var input = document.createElement("input");
      input.type = "text";
      input.className = "memo-toolbar-rename-input";
      input.value = memo.name;

      function finish() {
        var newName = input.value.trim() || memo.name;
        if (newName !== memo.name) {
          memo.name = newName;
          serverCall("renameMemo", activeId, newName).catch(function () {});
        }
        render();
      }

      input.addEventListener("blur", finish);
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") { e.preventDefault(); input.blur(); }
        if (e.key === "Escape") { input.value = memo.name; input.blur(); }
      });

      nameEl.textContent = "";
      nameEl.onclick = null;
      nameEl.appendChild(input);
      input.focus();
      input.select();
    }

    // =========================================================
    // Toggle sidebar collapse
    // =========================================================
    function toggleCollapse() {
      var sidebar = document.getElementById("memo-sidebar");
      if (!sidebar) return;
      var collapsed = sidebar.classList.toggle("collapsed");
      lsSet("gas_pomodoro_memo_sidebar_collapsed", collapsed ? "1" : "");
    }

    // =========================================================
    // Filter memos
    // =========================================================
    function filterMemos() {
      applyFilters();
    }

    // =========================================================
    // Tag operations
    // =========================================================
    function addTagToMemo(id, tag) {
      var memo = memos.find(function (m) { return m.id === id; });
      if (!memo) return;
      if (memo.tags.indexOf(tag) !== -1) return;
      memo.tags.push(tag);
      serverCall("updateMemoTags", id, memo.tags).catch(function () {});
      render();
      updateToolbar();
    }

    function removeTagFromMemo(id, tag) {
      var memo = memos.find(function (m) { return m.id === id; });
      if (!memo) return;
      memo.tags = memo.tags.filter(function (t) { return t !== tag; });
      serverCall("updateMemoTags", id, memo.tags).catch(function () {});
      render();
      updateToolbar();
    }

    function addNewTag(name, color) {
      var c = color || "#757575";
      // Check if already exists
      var existing = memoTags.find(function (t) { return t.name === name; });
      if (existing) return;
      memoTags.push({
        name: name,
        color: c,
        sortOrder: memoTags.length + 1,
        isActive: true,
      });
      render();
      serverCall("addMemoTag", name, c).catch(function () {});
    }

    function updateMemoTagColorLocal(name, color) {
      var tag = memoTags.find(function (t) { return t.name === name; });
      if (tag) tag.color = color;
      serverCall("updateMemoTagColor", name, color).catch(function () {});
      render();
      updateToolbar();
    }

    // =========================================================
    // Context menu
    // =========================================================
    var contextMenuEl = null;

    function showContextMenu(e, id) {
      e.preventDefault();
      e.stopPropagation();
      if (sidebarBusy) return;
      hideContextMenu();

      var memo = memos.find(function (m) { return m.id === id; });
      if (!memo) return;

      contextMenuEl = document.createElement("div");
      contextMenuEl.className = "memo-context-menu";

      // Rename
      var renameBtn = document.createElement("div");
      renameBtn.className = "memo-context-item";
      renameBtn.textContent = "名前変更";
      renameBtn.onclick = function () { hideContextMenu(); startRename(id); };
      contextMenuEl.appendChild(renameBtn);

      // Delete
      var deleteBtn = document.createElement("div");
      deleteBtn.className = "memo-context-item memo-context-danger";
      deleteBtn.textContent = "削除";
      deleteBtn.onclick = function () { hideContextMenu(); deleteMemoDo(id); };
      contextMenuEl.appendChild(deleteBtn);

      // Tags
      var tagHeader = document.createElement("div");
      tagHeader.className = "memo-context-separator";
      tagHeader.textContent = "タグ";
      contextMenuEl.appendChild(tagHeader);

      memoTags.forEach(function (tag) {
        var tagItem = document.createElement("div");
        tagItem.className = "memo-context-item";
        var hasTag = memo.tags.indexOf(tag.name) !== -1;
        var dot = document.createElement("span");
        dot.className = "memo-tag-dot";
        dot.style.background = tag.color;
        tagItem.appendChild(dot);
        tagItem.appendChild(document.createTextNode(tag.name));
        if (hasTag) {
          var chk = document.createElement("span");
          chk.className = "memo-context-check";
          chk.innerHTML = checkSvg(12);
          tagItem.appendChild(chk);
        }
        tagItem.onclick = function () {
          hideContextMenu();
          if (hasTag) removeTagFromMemo(id, tag.name);
          else addTagToMemo(id, tag.name);
        };
        contextMenuEl.appendChild(tagItem);
      });

      // New tag
      var newTagBtn = document.createElement("div");
      newTagBtn.className = "memo-context-item";
      newTagBtn.textContent = "+ 新しいタグ";
      newTagBtn.onclick = function () {
        hideContextMenu();
        var name = prompt("タグ名:");
        if (name && name.trim()) {
          addNewTag(name.trim());
          addTagToMemo(id, name.trim());
        }
      };
      contextMenuEl.appendChild(newTagBtn);

      // Position
      contextMenuEl.style.left = e.clientX + "px";
      contextMenuEl.style.top = e.clientY + "px";
      document.body.appendChild(contextMenuEl);

      // Adjust if off-screen
      var rect = contextMenuEl.getBoundingClientRect();
      if (rect.right > window.innerWidth) {
        contextMenuEl.style.left = (window.innerWidth - rect.width - 8) + "px";
      }
      if (rect.bottom > window.innerHeight) {
        contextMenuEl.style.top = (window.innerHeight - rect.height - 8) + "px";
      }

      setTimeout(function () {
        document.addEventListener("click", hideContextMenu, { once: true });
      }, 0);
    }

    function hideContextMenu() {
      if (contextMenuEl) {
        contextMenuEl.remove();
        contextMenuEl = null;
      }
    }

    // =========================================================
    // Toolbar (memo name + tags above editor)
    // =========================================================
    var tagPicker = null;

    function initTagPicker() {
      if (tagPicker) return;
      tagPicker = ItemPicker.create({
        containerId: "memo-tag-picker-area",
        mode: "multi",
        items: memoTags,
        selected: [],
        placeholder: "\u30BF\u30B0\u3092\u691C\u7D22 / \u4F5C\u6210...",
        onAdd: function (name) {
          if (!activeId) return;
          // Ensure tag exists in memoTags
          var existing = memoTags.find(function (t) { return t.name === name; });
          if (!existing) {
            addNewTag(name, "#757575");
            tagPicker.setItems(memoTags);
          }
          addTagToMemo(activeId, name);
        },
        onRemove: function (name) {
          if (!activeId) return;
          removeTagFromMemo(activeId, name);
        },
        onCreateItem: function (name, color) {
          addNewTag(name, color);
          tagPicker.setItems(memoTags);
        },
        onColorChange: function (name, color) {
          updateMemoTagColorLocal(name, color);
          tagPicker.setItems(memoTags);
        },
      });
    }

    function updateToolbar() {
      var toolbar = document.getElementById("memo-editor-toolbar");
      if (!toolbar) return;

      var memo = activeId ? memos.find(function (m) { return m.id === activeId; }) : null;
      if (!memo) {
        toolbar.style.display = "none";
        return;
      }
      toolbar.style.display = "";

      var nameEl = toolbar.querySelector(".memo-toolbar-name");
      if (nameEl) {
        nameEl.textContent = memo.name;
        nameEl.onclick = function () { startToolbarRename(nameEl); };
      }

      // Update tag picker
      initTagPicker();
      tagPicker.setItems(memoTags);
      tagPicker.setSelected(memo.tags.slice());
    }

    // =========================================================
    // Render sidebar
    // =========================================================
    function render() {
      var sidebar = document.getElementById("memo-sidebar");
      if (!sidebar) return;

      // Restore collapsed state
      var isCollapsed = ls("gas_pomodoro_memo_sidebar_collapsed") === "1";
      if (isCollapsed) sidebar.classList.add("collapsed");
      else sidebar.classList.remove("collapsed");

      renderTagFilters();

      var listEl = sidebar.querySelector(".memo-sidebar-list");
      if (!listEl) return;
      listEl.innerHTML = "";

      if (memos.length === 0) {
        var empty = document.createElement("div");
        empty.className = "memo-sidebar-empty";
        empty.textContent = "メモがありません";
        listEl.appendChild(empty);
        updateToolbar();
        return;
      }

      // Flat list of all memos
      memos.forEach(function (m) {
        listEl.appendChild(createMemoItem(m));
      });

      applyFilters();
      updateToolbar();
    }

    function buildFilterBtn() {
      var btn = document.createElement("button");
      btn.type = "button";

      if (activeTagFilter) {
        var activeTag = memoTags.find(function (t) { return t.name === activeTagFilter; });
        var tagColor = activeTag ? activeTag.color : "#757575";
        btn.className = "memo-tag-filter-btn active";
        btn.style.borderColor = tagColor;

        var dot = document.createElement("span");
        dot.className = "memo-tag-dot";
        dot.style.background = tagColor;
        btn.appendChild(dot);

        btn.appendChild(document.createTextNode(activeTagFilter));

        var clearX = document.createElement("span");
        clearX.className = "memo-tag-filter-clear";
        clearX.textContent = "\u00d7";
        clearX.onclick = function (e) {
          e.stopPropagation();
          activeTagFilter = null;
          closeTagFilterDropdown();
          render();
        };
        btn.appendChild(clearX);

        var arrow = document.createElement("span");
        arrow.className = "memo-tag-filter-arrow";
        arrow.textContent = "\u25BC";
        btn.appendChild(arrow);
      } else {
        btn.className = "memo-tag-filter-btn";
        var label = document.createTextNode("\u30BF\u30B0");
        btn.appendChild(label);
        var arrow = document.createElement("span");
        arrow.className = "memo-tag-filter-arrow";
        arrow.textContent = "\u25BC";
        btn.appendChild(arrow);
      }

      return btn;
    }

    function renderTagFilters() {
      var container = document.querySelector(".memo-tag-filters");
      if (!container) return;
      container.innerHTML = "";

      // Collect tags that are actually used by at least one memo
      var usedTags = memoTags.filter(function (tag) {
        return memos.some(function (m) { return m.tags.indexOf(tag.name) !== -1; });
      });

      if (usedTags.length === 0) {
        container.style.display = "none";
        return;
      }
      container.style.display = "";

      var btn = buildFilterBtn();
      btn.onclick = function (e) {
        e.stopPropagation();
        if (tagFilterDropdownOpen) {
          closeTagFilterDropdown();
        } else {
          openTagFilterDropdown(container);
        }
      };

      container.appendChild(btn);
    }

    function openTagFilterDropdown(container) {
      closeTagFilterDropdown();
      tagFilterDropdownOpen = true;

      var usedTags = memoTags.filter(function (tag) {
        return memos.some(function (m) { return m.tags.indexOf(tag.name) !== -1; });
      });

      tagFilterDropdownEl = document.createElement("div");
      tagFilterDropdownEl.className = "memo-tag-dropdown";
      tagFilterDropdownEl.style.position = "absolute";
      tagFilterDropdownEl.style.left = "0";
      tagFilterDropdownEl.style.right = "0";
      tagFilterDropdownEl.style.width = "auto";

      // Search input
      var searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.className = "memo-tag-dropdown-search";
      searchInput.placeholder = "\u30BF\u30B0\u3092\u691C\u7D22...";
      tagFilterDropdownEl.appendChild(searchInput);

      var listEl = document.createElement("div");
      listEl.className = "memo-tag-dropdown-list";
      tagFilterDropdownEl.appendChild(listEl);

      function renderFilterList(filter) {
        listEl.innerHTML = "";
        var q = (filter || "").toLowerCase();

        var filtered = usedTags.filter(function (t) {
          if (!q) return true;
          return t.name.toLowerCase().indexOf(q) !== -1;
        });

        filtered.forEach(function (tag) {
          var item = document.createElement("div");
          item.className = "memo-tag-dropdown-item";

          var dot = document.createElement("span");
          dot.className = "memo-tag-dropdown-dot";
          dot.style.background = tag.color;

          var label = document.createElement("span");
          label.className = "memo-tag-dropdown-label";
          label.textContent = tag.name;

          var check = document.createElement("span");
          check.className = "memo-tag-dropdown-check";
          if (activeTagFilter === tag.name) {
            check.innerHTML = checkSvg(14);
          }

          item.appendChild(dot);
          item.appendChild(label);
          item.appendChild(check);

          (function (tagName) {
            item.addEventListener("mousedown", function (e) {
              e.preventDefault();
              activeTagFilter = activeTagFilter === tagName ? null : tagName;
              applyFilters();
              renderFilterList(searchInput.value.trim());
              renderTagFilterButton(container);
            });
          })(tag.name);

          listEl.appendChild(item);
        });
      }

      searchInput.addEventListener("input", function () {
        renderFilterList(searchInput.value.trim());
      });

      renderFilterList("");

      container.appendChild(tagFilterDropdownEl);

      setTimeout(function () { searchInput.focus(); }, 0);

      setTimeout(function () {
        document.addEventListener("mousedown", handleTagFilterOutsideClick);
      }, 0);
    }

    function renderTagFilterButton(container) {
      var oldBtn = container.querySelector(".memo-tag-filter-btn");
      if (!oldBtn) return;
      var newBtn = buildFilterBtn();
      newBtn.onclick = oldBtn.onclick;
      oldBtn.replaceWith(newBtn);
    }

    function handleTagFilterOutsideClick(e) {
      if (tagFilterDropdownEl && !tagFilterDropdownEl.contains(e.target) &&
          !e.target.closest(".memo-tag-filter-btn")) {
        closeTagFilterDropdown();
      }
    }

    function closeTagFilterDropdown() {
      tagFilterDropdownOpen = false;
      if (tagFilterDropdownEl) {
        tagFilterDropdownEl.remove();
        tagFilterDropdownEl = null;
      }
      document.removeEventListener("mousedown", handleTagFilterOutsideClick);
    }

    // =========================================================
    // Drag & drop reorder
    // =========================================================
    function gripSvg() {
      return '<svg width="10" height="14" viewBox="0 0 10 14" fill="currentColor">' +
        '<circle cx="3" cy="2" r="1.2"/><circle cx="7" cy="2" r="1.2"/>' +
        '<circle cx="3" cy="7" r="1.2"/><circle cx="7" cy="7" r="1.2"/>' +
        '<circle cx="3" cy="12" r="1.2"/><circle cx="7" cy="12" r="1.2"/>' +
        '</svg>';
    }

    function isReorderEnabled() {
      if (sidebarBusy) return false;
      if (memos.length <= 1) return false;
      var searchInput = document.querySelector(".memo-search-input");
      var q = searchInput ? searchInput.value.trim() : "";
      if (q || activeTagFilter) return false;
      return true;
    }

    function startDrag(e, id, el) {
      var listEl = el.parentNode;
      if (!listEl) return;

      var rect = el.getBoundingClientRect();
      var offsetY = e.clientY - rect.top;

      // Create ghost (clone)
      var clone = el.cloneNode(true);
      clone.className = "memo-sidebar-item memo-drag-ghost";
      clone.style.position = "fixed";
      clone.style.left = rect.left + "px";
      clone.style.top = (e.clientY - offsetY) + "px";
      clone.style.width = rect.width + "px";
      clone.style.zIndex = "300";
      clone.style.pointerEvents = "none";
      document.body.appendChild(clone);

      // Create placeholder
      var placeholder = document.createElement("div");
      placeholder.className = "memo-drag-placeholder";
      placeholder.style.height = rect.height + "px";
      listEl.insertBefore(placeholder, el);

      // Hide original
      el.style.display = "none";

      listEl.classList.add("is-reordering");

      dragState = {
        id: id,
        el: el,
        clone: clone,
        placeholder: placeholder,
        listEl: listEl,
        startY: e.clientY,
        offsetY: offsetY,
      };

      document.addEventListener("pointermove", onDragMove);
      document.addEventListener("pointerup", onDragEnd);
      document.addEventListener("pointercancel", onDragEnd);
    }

    function onDragMove(e) {
      if (!dragState) return;
      e.preventDefault();

      // Update ghost position
      dragState.clone.style.top = (e.clientY - dragState.offsetY) + "px";

      // Determine insertion point among visible items
      var items = dragState.listEl.querySelectorAll(".memo-sidebar-item:not([style*='display: none'])");
      var placeholder = dragState.placeholder;
      var inserted = false;

      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        if (item === dragState.el) continue;
        var r = item.getBoundingClientRect();
        var midY = r.top + r.height / 2;
        if (e.clientY < midY) {
          dragState.listEl.insertBefore(placeholder, item);
          inserted = true;
          break;
        }
      }
      if (!inserted) {
        // Place after last visible item
        dragState.listEl.appendChild(placeholder);
      }
    }

    function onDragEnd(e) {
      if (!dragState) return;
      document.removeEventListener("pointermove", onDragMove);
      document.removeEventListener("pointerup", onDragEnd);
      document.removeEventListener("pointercancel", onDragEnd);

      // Remove ghost
      dragState.clone.remove();

      // Restore original element at placeholder position
      dragState.el.style.display = "";
      dragState.listEl.insertBefore(dragState.el, dragState.placeholder);
      dragState.placeholder.remove();

      dragState.listEl.classList.remove("is-reordering");

      // Read new order from DOM
      var domItems = dragState.listEl.querySelectorAll(".memo-sidebar-item");
      var newOrderIds = [];
      for (var i = 0; i < domItems.length; i++) {
        var did = domItems[i].getAttribute("data-id");
        if (did) newOrderIds.push(did);
      }

      // Rebuild memos array in new order
      var memoMap = {};
      memos.forEach(function (m) { memoMap[m.id] = m; });
      var newMemos = [];
      for (var j = 0; j < newOrderIds.length; j++) {
        var m = memoMap[newOrderIds[j]];
        if (m) {
          m.sortOrder = j + 1;
          newMemos.push(m);
        }
      }
      // Add any memos not in the DOM (shouldn't happen, but be safe)
      memos.forEach(function (m) {
        if (newOrderIds.indexOf(m.id) === -1) newMemos.push(m);
      });
      memos = newMemos;

      // Queue server save
      pendingOrder = newOrderIds;
      flushOrderSave();

      dragState = null;
    }

    function flushOrderSave() {
      if (savingOrder) return;
      if (!pendingOrder) return;
      var order = pendingOrder;
      pendingOrder = null;
      savingOrder = true;
      serverCall("updateMemoSortOrders", order)
        .catch(function (err) {
          console.error("Failed to save memo order:", err);
        })
        .finally(function () {
          savingOrder = false;
          if (pendingOrder) flushOrderSave();
        });
    }

    function applyFilters() {
      var searchInput = document.querySelector(".memo-search-input");
      var q = (searchInput ? searchInput.value : "").toLowerCase();
      var hasFilter = !!(q || activeTagFilter);
      var items = document.querySelectorAll(".memo-sidebar-item");
      items.forEach(function (item) {
        var nameMatch = !q || (item.getAttribute("data-name") || "").toLowerCase().indexOf(q) !== -1;
        var tagMatch = true;
        if (activeTagFilter) {
          var tags = (item.getAttribute("data-tags") || "").split(",");
          tagMatch = tags.indexOf(activeTagFilter) !== -1;
        }
        item.style.display = nameMatch && tagMatch ? "" : "none";
        var handle = item.querySelector(".memo-drag-handle");
        if (handle) handle.style.display = hasFilter ? "none" : "";
      });
    }

    function createMemoItem(memo) {
      var item = document.createElement("div");
      item.className = "memo-sidebar-item" + (memo.id === activeId ? " active" : "");
      item.setAttribute("data-id", memo.id);
      item.setAttribute("data-name", memo.name);
      item.setAttribute("data-tags", memo.tags.join(","));

      // Drag handle
      var handle = document.createElement("span");
      handle.className = "memo-drag-handle";
      handle.innerHTML = gripSvg();
      handle.addEventListener("pointerdown", function (e) {
        if (!isReorderEnabled()) return;
        e.preventDefault();
        startDrag(e, memo.id, item);
      });
      item.appendChild(handle);

      var nameSpan = document.createElement("span");
      nameSpan.className = "memo-item-name";
      nameSpan.textContent = memo.name;
      item.appendChild(nameSpan);

      // Tag color dots
      if (memo.tags.length > 0) {
        var dotsSpan = document.createElement("span");
        dotsSpan.className = "memo-item-tags";
        memo.tags.forEach(function (tagName) {
          var tag = memoTags.find(function (t) { return t.name === tagName; });
          var dot = document.createElement("span");
          dot.className = "memo-tag-dot";
          dot.style.background = tag ? tag.color : "#757575";
          dotsSpan.appendChild(dot);
        });
        item.appendChild(dotsSpan);
      }

      item.onclick = function () { selectMemo(memo.id); };
      item.oncontextmenu = function (e) { showContextMenu(e, memo.id); };

      return item;
    }

    // =========================================================
    // Public API
    // =========================================================
    return {
      init: init,
      initAfterEditorMount: initAfterEditorMount,
      render: render,
      selectMemo: selectMemo,
      createMemo: createMemo,
      deleteMemo: deleteMemoDo,
      toggleCollapse: toggleCollapse,
      filterMemos: filterMemos,
      saveCurrent: saveCurrent,
      addTagToMemo: addTagToMemo,
      removeTagFromMemo: removeTagFromMemo,
      getActiveId: function () { return activeId; },
      getAllMemos: function () { return memos; },
    };
  })();
</script>
