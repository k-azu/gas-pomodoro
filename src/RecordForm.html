<script>
  var RecordForm = (function () {
    var recordPicker = null;
    var selectedTaskId = null;

    function initPicker() {
      if (recordPicker) return;
      recordPicker = ItemPicker.create({
        containerId: "record-category-area",
        mode: "single",
        items: [],
        selected: [],
        placeholder: "\u30AB\u30C6\u30B4\u30EA\u3092\u691C\u7D22 / \u4F5C\u6210...",
        onAdd: function () {},
        onRemove: function () {},
        onCreateItem: function () {},
        onColorChange: function (name, color) {
          serverCall("updateCategoryColor", name, color, "Categories");
        },
      });
    }

    function clearForm() {
      MemoEditor.clearRecord();
      if (recordPicker) {
        recordPicker.setSelected([]);
      }
      selectedTaskId = null;
      if (taskPicker) {
        taskPicker.setSelected([]);
      }
    }

    function populateCategories(categories) {
      initPicker();
      recordPicker.setItems(categories);
    }

    function renderInterruptionList() {
      var container = document.getElementById("interruption-list");
      var state = App.getState();
      var interruptions = state.interruptions;
      container.innerHTML = "";

      if (interruptions.length === 0) {
        container.style.display = "none";
        return;
      }

      container.style.display = "";

      // Summary line
      var totalSecs = interruptions.reduce(function (s, i) {
        return s + i.durationSeconds;
      }, 0);
      var totalMins = Math.floor(totalSecs / 60);
      var totalRemSecs = totalSecs % 60;
      var totalStr =
        totalMins > 0
          ? totalMins + "分" + (totalRemSecs > 0 ? totalRemSecs + "秒" : "")
          : totalRemSecs + "秒";

      var summary = document.createElement("div");
      summary.className = "interruption-summary";
      summary.textContent =
        "中断 " + interruptions.length + "回 (計" + totalStr + ")";
      container.appendChild(summary);

      // Compact clickable list
      var list = document.createElement("div");
      list.className = "interruption-compact-list";

      interruptions.forEach(function (int, index) {
        var row = document.createElement("div");
        row.className = "interruption-compact-item";
        row.onclick = function () {
          openInterruptionInViewer(index);
        };

        var typeLabel = int.type === "work" ? "作業" : "非作業";
        var mins = Math.floor(int.durationSeconds / 60);
        var secs = int.durationSeconds % 60;
        var durStr = String(mins).padStart(2, "0") + ":" + String(secs).padStart(2, "0");

        var lines = int.note ? int.note.split("\n") : [];
        var title = lines[0] ? lines[0].trim() : "";

        var parts = [];
        parts.push(typeLabel);
        parts.push(durStr);
        if (int.category) parts.push(int.category);
        if (title) parts.push(title);

        row.textContent = parts.join(" · ");

        if (int.category) {
          var intCatColor = getInterruptionCategoryColor(int.category);
          if (intCatColor) row.style.borderLeftColor = intCatColor;
        }

        list.appendChild(row);
      });

      container.appendChild(list);
    }

    function openInterruptionInViewer(index) {
      var int = App.getState().interruptions[index];
      if (!int) return;

      TabPanel.showViewer("", "", int.note || "", null, null, {
        category: int.category || "",
        sheetType: "InterruptionCategories",
        interruptionType: int.type,
        startTime: int.startTime,
        endTime: int.endTime,
        saveCallback: function (markdown) {
          App.getState().interruptions[index].note = markdown;
          renderInterruptionList();
        },
        categorySaveCallback: function (newCategory) {
          App.getState().interruptions[index].category = newCategory;
          renderInterruptionList();
        },
        typeSaveCallback: function (newType) {
          App.getState().interruptions[index].type = newType;
          renderInterruptionList();
        },
        timeSaveCallback: function (startISO, endISO, durSecs) {
          App.getState().interruptions[index].startTime = startISO;
          App.getState().interruptions[index].endTime = endISO;
          App.getState().interruptions[index].durationSeconds = durSecs;
          renderInterruptionList();
        },
      });
    }

    function ensureCategory(category) {
      if (!category) return Promise.resolve();
      var exists = App.getState().categories.some(function (c) {
        return c.name === category;
      });
      if (exists) return Promise.resolve();
      var color = recordPicker ? recordPicker.getColor(category) : "#757575";
      return serverCall("addCategory", category, color).then(function (result) {
        if (result.success) {
          return serverCall("getCategories").then(function (cats) {
            if (cats) {
              App.getState().categories = cats;
              populateCategories(cats);
            }
          });
        }
      });
    }

    // action: "break" | "nextWork" | "endSession"
    function submitAndDo(action) {
      var state = App.getState();
      if (state.phase !== "work") return;

      var endTime = new Date();
      var description = (MemoEditor.getRecordValue() || "").trim();
      var category = recordPicker ? (recordPicker.getSelected()[0] || "") : "";
      var startTime = new Date(state.startTimestamp);
      var actualSeconds = Math.round(
        (endTime.getTime() - startTime.getTime()) / 1000,
      );

      // Auto-determine completionStatus based on elapsed vs target
      var completionStatus =
        state.elapsedSeconds >= state.totalSeconds ? "completed" : "abandoned";

      var record = buildRecord(
        state,
        description,
        category,
        startTime,
        endTime,
        actualSeconds,
        completionStatus,
      );
      var intRecords = buildInterruptionRecords(state, record.id);

      showLoading(true);
      ensureCategory(category)
        .then(function () {
          return serverCall("saveRecord", record);
        })
        .then(function () {
          if (intRecords.length > 0) {
            return serverCall("saveInterruptions", intRecords);
          }
        })
        .then(function () {
          clearForm();
          if (action === "break") {
            App.onRecordSaved();
          } else if (action === "nextWork") {
            App.startNextWork();
          } else {
            App.endWorkSession();
          }
          refreshAll();
        })
        .catch(function (err) {
          alert("記録の保存に失敗しました: " + err);
        })
        .finally(function () {
          showLoading(false);
        });
    }

    function buildRecord(
      state,
      description,
      category,
      startTime,
      endTime,
      actualSeconds,
      completionStatus,
    ) {
      var workCount = state.interruptions.filter(function (i) {
        return i.type === "work";
      }).length;
      var nonWorkCount = state.interruptions.filter(function (i) {
        return i.type === "nonWork";
      }).length;
      var workIntSeconds = state.interruptions
        .filter(function (i) {
          return i.type === "work";
        })
        .reduce(function (sum, i) {
          return sum + i.durationSeconds;
        }, 0);
      var nonWorkIntSeconds = state.interruptions
        .filter(function (i) {
          return i.type === "nonWork";
        })
        .reduce(function (sum, i) {
          return sum + i.durationSeconds;
        }, 0);

      return {
        id: generateUUID(),
        date: formatDate(endTime),
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        durationSeconds: state.config.workMinutes * 60,
        actualDurationSeconds: actualSeconds,
        type: "work",
        description: description,
        category: category,
        workInterruptions: workCount,
        nonWorkInterruptions: nonWorkCount,
        workInterruptionSeconds: workIntSeconds,
        nonWorkInterruptionSeconds: nonWorkIntSeconds,
        completionStatus: completionStatus,
        pomodoroSetIndex: state.pomodoroSetIndex,
        taskId: selectedTaskId || "",
      };
    }

    function buildInterruptionRecords(state, pomodoroId) {
      return state.interruptions.map(function (i) {
        return {
          id: i.id,
          pomodoroId: pomodoroId,
          type: i.type,
          startTime: i.startTime,
          endTime: i.endTime,
          durationSeconds: i.durationSeconds,
          category: i.category || "",
          note: i.note || "",
        };
      });
    }

    function getInterruptionCategoryColor(name) {
      var cats = App.getState().interruptionCategories;
      var cat = cats.find(function (c) {
        return c.name === name;
      });
      return cat ? cat.color : "";
    }

    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
        /[xy]/g,
        function (c) {
          var r = (Math.random() * 16) | 0;
          var v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        },
      );
    }

    function formatDate(d) {
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + day;
    }

    function setRecordEditorLoading(on) {
      var container = document.getElementById("record-editor-container");
      if (!container) return;
      var overlay = container.querySelector(".memo-editor-loading-overlay");
      if (on) {
        if (overlay) return;
        container.style.position = "relative";
        overlay = document.createElement("div");
        overlay.className = "memo-editor-loading-overlay";
        overlay.innerHTML = '<div class="memo-editor-loading-spinner"></div>';
        container.appendChild(overlay);
      } else {
        if (overlay) overlay.remove();
      }
    }

    function copyFromPrevious() {
      setRecordEditorLoading(true);
      serverCall("getLastWorkRecord")
        .then(function (result) {
          if (!result) return;
          if (result.description) MemoEditor.setRecordValue(result.description);
          if (result.category && recordPicker) recordPicker.setSelected([result.category]);
          selectedTaskId = result.taskId || null;
          if (taskPicker) {
            if (selectedTaskId) {
              refreshTaskPickerItems();
            } else {
              taskPicker.setSelected([]);
            }
          }
        })
        .finally(function () {
          setRecordEditorLoading(false);
        });
    }

    // Task Picker (ItemPicker-based, flat list like mentions)
    var taskPicker = null;
    var _taskItemMap = {}; // label -> taskId

    function renderTaskPicker() {
      var area = document.getElementById("record-task-area");
      if (!area) return;

      if (typeof TaskStore === "undefined") {
        area.innerHTML = "";
        return;
      }

      if (taskPicker) {
        taskPicker.destroy();
        taskPicker = null;
      }
      _taskItemMap = {};

      taskPicker = ItemPicker.create({
        containerId: "record-task-area",
        mode: "single",
        items: [],
        selected: [],
        placeholder: "タスクを検索...",
        onAdd: function (label) {
          selectedTaskId = _taskItemMap[label] || null;
        },
        onRemove: function () {
          selectedTaskId = null;
        },
        onCreateItem: function () {},
        onColorChange: function () {},
      });

      refreshTaskPickerItems();

      if (typeof TaskStore !== "undefined") {
        TaskStore.on("dataChanged", function () {
          refreshTaskPickerItems();
        });
      }
    }

    function refreshTaskPickerItems() {
      if (!taskPicker || typeof TaskStore === "undefined") return;

      var sc = (typeof TaskPanel !== "undefined" && TaskPanel.STATUS_CONFIG) ? TaskPanel.STATUS_CONFIG : {};

      Promise.all([
        TaskStore.getAllTasks(),
        TaskStore.getAllProjects(),
        TaskStore.getAllCases(),
      ]).then(function (results) {
        var tasks = results[0];
        var projects = results[1];
        var cases = results[2];

        var projMap = {};
        projects.forEach(function (p) { projMap[p.id] = p.name; });
        var caseMap = {};
        cases.forEach(function (c) { caseMap[c.id] = c; });

        _taskItemMap = {};
        var items = [];
        tasks.forEach(function (t) {
          if (t.status === "done" || t.status === "docs") return;
          var path = projMap[t.projectId] || "";
          if (t.caseId && caseMap[t.caseId]) {
            path += " > " + caseMap[t.caseId].name;
          }
          var label = t.name + (path ? " (" + path + ")" : "");
          var statusColor = (sc[t.status] || { color: "#9e9e9e" }).color;
          _taskItemMap[label] = t.id;
          items.push({ name: label, color: statusColor });
        });

        taskPicker.setItems(items);

        // Restore selection if selectedTaskId is set
        if (selectedTaskId) {
          var selectedLabel = null;
          Object.keys(_taskItemMap).forEach(function (lbl) {
            if (_taskItemMap[lbl] === selectedTaskId) selectedLabel = lbl;
          });
          if (selectedLabel) {
            taskPicker.setSelected([selectedLabel]);
          }
        }
      });
    }

    return {
      submitAndDo: submitAndDo,
      clearForm: clearForm,
      renderInterruptionList: renderInterruptionList,
      openInterruptionInViewer: openInterruptionInViewer,
      populateCategories: populateCategories,
      ensureCategory: ensureCategory,
      generateUUID: generateUUID,
      formatDate: formatDate,
      copyFromPrevious: copyFromPrevious,
      renderTaskPicker: renderTaskPicker,
    };
  })();
</script>
