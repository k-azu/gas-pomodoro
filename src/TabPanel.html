<script>
  var TabPanel = (function () {
    var activeTab = "memo";
    var lastAutoPhase = null;

    // Which tabs are visible per phase
    var tabVisibility = {
      idle: { memo: true, record: false, interruption: false },
      work: { memo: true, record: true, interruption: false },
      interrupted: { memo: true, record: true, interruption: true },
      recording: { memo: true, record: true, interruption: false },
      abandoning: { memo: true, record: true, interruption: false },
      shortBreak: { memo: true, record: false, interruption: false },
      longBreak: { memo: true, record: false, interruption: false },
      breakDone: { memo: true, record: false, interruption: false },
    };

    // Auto-switch target when entering a new phase
    var autoSwitchTarget = {
      idle: "memo",
      work: "record",
      interrupted: "interruption",
      recording: "record",
      abandoning: "record",
      shortBreak: "memo",
      longBreak: "memo",
      breakDone: "memo",
    };

    function init() {
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var tabId = btn.getAttribute("data-tab");
          switchTab(tabId);
        });
      });
    }

    function switchTab(tabId) {
      // Deactivate all
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        btn.classList.remove("active");
      });
      var contents = document.querySelectorAll(".tab-content");
      contents.forEach(function (c) {
        c.style.display = "none";
        c.classList.remove("active");
      });

      // Activate target
      var targetBtn = document.querySelector(
        '.tab-btn[data-tab="' + tabId + '"]',
      );
      if (targetBtn) targetBtn.classList.add("active");
      var targetContent = document.querySelector(
        '.tab-content[data-tab-content="' + tabId + '"]',
      );
      if (targetContent) {
        targetContent.style.display = "flex";
        targetContent.classList.add("active");
      }

      // Update action buttons visibility
      var actionButtons = document.querySelectorAll(".tab-action-btn");
      actionButtons.forEach(function (btn) {
        var forTab = btn.getAttribute("data-tab-action");
        btn.style.display = forTab === tabId ? "" : "none";
      });

      activeTab = tabId;
    }

    var viewerOpen = false;
    var viewerRecordId = null;   // record or interruption ID
    var viewerRecordType = null; // "record" or "interruption"

    function showViewer(title, meta, markdown, recordId, recordType) {
      // Show viewer tab button
      var viewerBtn = document.querySelector('.tab-btn[data-tab="viewer"]');
      if (viewerBtn) viewerBtn.style.display = "";
      viewerOpen = true;
      viewerRecordId = recordId || null;
      viewerRecordType = recordType || null;

      // Set header content
      document.getElementById("viewer-title").textContent = title || "";
      document.getElementById("viewer-meta").textContent = meta || "";

      // Show/hide save button based on whether we have a record to save to
      var saveBtn = document.getElementById("viewer-save-btn");
      if (saveBtn) saveBtn.style.display = viewerRecordId ? "" : "none";

      // Set editor content
      MemoEditor.setViewerValue(markdown || "");

      // Switch to viewer tab
      switchTab("viewer");
    }

    function saveViewer() {
      if (!viewerRecordId) return;
      var markdown = MemoEditor.getViewerValue();
      var saveBtn = document.getElementById("viewer-save-btn");
      if (saveBtn) saveBtn.disabled = true;

      var fn = viewerRecordType === "interruption"
        ? "updateInterruptionNote"
        : "updateRecordDescription";

      serverCall(fn, viewerRecordId, markdown)
        .then(function () {
          if (saveBtn) saveBtn.disabled = false;
          refreshHistory();
        })
        .catch(function (err) {
          if (saveBtn) saveBtn.disabled = false;
          alert("保存に失敗しました: " + err);
        });
    }

    function hideViewer() {
      var viewerBtn = document.querySelector('.tab-btn[data-tab="viewer"]');
      if (viewerBtn) viewerBtn.style.display = "none";
      viewerOpen = false;

      MemoEditor.clearViewer();

      // Fall back to memo tab
      switchTab("memo");
    }

    function update(phase) {
      var visibility = tabVisibility[phase] || tabVisibility.idle;

      // Show/hide tab buttons (viewer is managed separately)
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        var tabId = btn.getAttribute("data-tab");
        if (tabId === "viewer") {
          // Viewer tab visibility is managed by showViewer/hideViewer
          btn.style.display = viewerOpen ? "" : "none";
          return;
        }
        btn.style.display = visibility[tabId] ? "" : "none";
      });

      // Auto-switch tab on phase change
      if (phase !== lastAutoPhase) {
        var target = autoSwitchTarget[phase] || "memo";
        // Only auto-switch if the target tab is visible
        if (visibility[target]) {
          switchTab(target);
        } else {
          switchTab("memo");
        }
        lastAutoPhase = phase;
      } else {
        // If current tab became invisible (and not viewer), fall back to memo
        if (activeTab !== "viewer" && !visibility[activeTab]) {
          switchTab("memo");
        }
      }
    }

    function getActiveTab() {
      return activeTab;
    }

    return {
      init: init,
      switchTab: switchTab,
      update: update,
      getActiveTab: getActiveTab,
      showViewer: showViewer,
      hideViewer: hideViewer,
      saveViewer: saveViewer,
    };
  })();
</script>
