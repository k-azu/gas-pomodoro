<script>
  var TabPanel = (function () {
    var activeTab = "memo";
    var lastAutoPhase = null;

    // Which tabs are visible per phase
    var tabVisibility = {
      idle: { memo: true, record: false, interruption: false },
      work: { memo: true, record: true, interruption: false },
      interrupted: { memo: true, record: true, interruption: true },
      shortBreak: { memo: true, record: false, interruption: false },
      longBreak: { memo: true, record: false, interruption: false },
      breakDone: { memo: true, record: false, interruption: false },
    };

    // Auto-switch target when entering a new phase
    var autoSwitchTarget = {
      idle: "memo",
      work: "record",
      interrupted: "interruption",
      shortBreak: "memo",
      longBreak: "memo",
      breakDone: "memo",
    };

    function init() {
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var tabId = btn.getAttribute("data-tab");
          switchTab(tabId);
        });
      });
    }

    function switchTab(tabId) {
      // Deactivate all
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        btn.classList.remove("active");
      });
      var contents = document.querySelectorAll(".tab-content");
      contents.forEach(function (c) {
        c.style.display = "none";
        c.classList.remove("active");
      });

      // Activate target
      var targetBtn = document.querySelector(
        '.tab-btn[data-tab="' + tabId + '"]',
      );
      if (targetBtn) targetBtn.classList.add("active");
      var targetContent = document.querySelector(
        '.tab-content[data-tab-content="' + tabId + '"]',
      );
      if (targetContent) {
        targetContent.style.display = "flex";
        targetContent.classList.add("active");
      }

      activeTab = tabId;

      // Notify link bubbles that editor visibility changed
      window.dispatchEvent(new Event("resize"));
    }

    var settingsOpen = false;

    var viewerOpen = false;
    var viewerRecordId = null;   // record or interruption ID
    var viewerRecordType = null; // "record" or "interruption"
    var viewerSaveCallback = null; // optional callback for in-memory save
    var viewerCategorySaveCallback = null; // optional callback for in-memory category save
    var viewerSheetType = null;  // "Categories" or "InterruptionCategories"
    var viewerOriginalCategory = ""; // track original category for change detection
    var viewerPicker = null;
    var viewerOriginalType = null; // "work" or "nonWork", null if not interruption
    var viewerTypeSaveCallback = null; // optional callback for in-memory type save
    var viewerOriginalStartISO = null; // original startTime ISO string
    var viewerOriginalEndISO = null;   // original endTime ISO string
    var viewerTimeSaveCallback = null; // optional callback for in-memory time save

    function initViewerPicker() {
      if (viewerPicker) return;
      viewerPicker = ItemPicker.create({
        containerId: "viewer-category-area",
        mode: "single",
        items: [],
        selected: [],
        placeholder: "\u30AB\u30C6\u30B4\u30EA\u3092\u691C\u7D22 / \u4F5C\u6210...",
        onAdd: function () {},
        onRemove: function () {},
        onCreateItem: function () {},
        onColorChange: function (name, color) {
          if (viewerSheetType) {
            serverCall("updateCategoryColor", name, color, viewerSheetType);
          }
        },
      });
    }

    function showViewer(title, meta, markdown, recordId, recordType, saveCallbackOrOpts) {
      initViewerPicker();

      // Show viewer tab button
      var viewerBtn = document.querySelector('.tab-btn[data-tab="viewer"]');
      if (viewerBtn) viewerBtn.style.display = "";
      viewerOpen = true;
      viewerRecordId = recordId || null;
      viewerRecordType = recordType || null;
      viewerSaveCallback = null;
      viewerCategorySaveCallback = null;
      viewerTypeSaveCallback = null;
      viewerTimeSaveCallback = null;
      viewerSheetType = null;
      viewerOriginalCategory = "";
      viewerOriginalType = null;
      viewerOriginalStartISO = null;
      viewerOriginalEndISO = null;

      // Parse opts (6th argument)
      var opts = {};
      if (typeof saveCallbackOrOpts === "function") {
        viewerSaveCallback = saveCallbackOrOpts;
      } else if (saveCallbackOrOpts && typeof saveCallbackOrOpts === "object") {
        opts = saveCallbackOrOpts;
        viewerSaveCallback = opts.saveCallback || null;
        viewerCategorySaveCallback = opts.categorySaveCallback || null;
        viewerTypeSaveCallback = opts.typeSaveCallback || null;
        viewerTimeSaveCallback = opts.timeSaveCallback || null;
      }

      // Category setup
      var category = opts.category || "";
      viewerSheetType = opts.sheetType || null;
      viewerOriginalCategory = category;

      if (viewerSheetType) {
        var state = App.getState();
        var cats = viewerSheetType === "InterruptionCategories"
          ? state.interruptionCategories
          : state.categories;
        viewerPicker.setItems(cats);
        viewerPicker.setSelected(category ? [category] : []);
        document.getElementById("viewer-category-area").style.display = "";
      } else {
        viewerPicker.setSelected([]);
        document.getElementById("viewer-category-area").style.display = "none";
      }

      // Interruption type toggle
      var typeLabel = document.getElementById("viewer-type-label");
      var typeCheckbox = document.getElementById("viewer-type-work");
      if (opts.interruptionType) {
        viewerOriginalType = opts.interruptionType;
        typeCheckbox.checked = opts.interruptionType === "work";
        typeLabel.style.display = "";
      } else {
        typeLabel.style.display = "none";
      }

      // Time group: show for records with startTime/endTime
      var timeGroup = document.getElementById("viewer-time-group");
      if (opts.startTime && opts.endTime) {
        viewerOriginalStartISO = opts.startTime;
        viewerOriginalEndISO = opts.endTime;
        var startInput = document.getElementById("viewer-start-time");
        var endInput = document.getElementById("viewer-end-time");
        var durationSpan = document.getElementById("viewer-duration");

        var sd = new Date(opts.startTime);
        var ed = new Date(opts.endTime);
        startInput.value = String(sd.getHours()).padStart(2, "0") + ":" + String(sd.getMinutes()).padStart(2, "0");
        endInput.value = String(ed.getHours()).padStart(2, "0") + ":" + String(ed.getMinutes()).padStart(2, "0");

        var updateDuration = function () {
          var sp = startInput.value.split(":");
          var ep = endInput.value.split(":");
          if (sp.length === 2 && ep.length === 2) {
            var mins = (parseInt(ep[0]) * 60 + parseInt(ep[1])) - (parseInt(sp[0]) * 60 + parseInt(sp[1]));
            if (mins < 0) mins += 1440;
            durationSpan.textContent = mins + "分";
          }
        };
        updateDuration();
        startInput.onchange = updateDuration;
        endInput.onchange = updateDuration;

        timeGroup.style.display = "";
      } else {
        timeGroup.style.display = "none";
      }

      // Show/hide save button based on whether we have a record to save to
      var saveBtn = document.getElementById("viewer-save-btn");
      if (saveBtn) saveBtn.style.display = (viewerRecordId || viewerSaveCallback) ? "" : "none";

      // Set editor content
      MemoEditor.setViewerValue(markdown || "");

      // Switch to viewer tab
      switchTab("viewer");
    }

    function getViewerType() {
      var typeCheckbox = document.getElementById("viewer-type-work");
      return typeCheckbox && typeCheckbox.checked ? "work" : "nonWork";
    }

    function saveViewer() {
      var markdown = MemoEditor.getViewerValue();
      var saveBtn = document.getElementById("viewer-save-btn");
      var newCategory = viewerPicker ? (viewerPicker.getSelected()[0] || "") : "";
      var categoryChanged = viewerSheetType && newCategory !== viewerOriginalCategory;
      var newType = viewerOriginalType ? getViewerType() : null;
      var typeChanged = newType && newType !== viewerOriginalType;

      // In-memory save (e.g. unsaved interruption notes)
      if (viewerSaveCallback) {
        viewerSaveCallback(markdown);
        if (viewerCategorySaveCallback && categoryChanged) {
          viewerCategorySaveCallback(newCategory);
        }
        if (viewerTypeSaveCallback && typeChanged) {
          viewerTypeSaveCallback(newType);
        }
        // In-memory time save
        if (viewerTimeSaveCallback && viewerOriginalStartISO && viewerOriginalEndISO) {
          var startInput = document.getElementById("viewer-start-time");
          var endInput = document.getElementById("viewer-end-time");
          var origSD = new Date(viewerOriginalStartISO);
          var origED = new Date(viewerOriginalEndISO);
          var origStartHM = String(origSD.getHours()).padStart(2, "0") + ":" + String(origSD.getMinutes()).padStart(2, "0");
          var origEndHM = String(origED.getHours()).padStart(2, "0") + ":" + String(origED.getMinutes()).padStart(2, "0");
          if (startInput.value !== origStartHM || endInput.value !== origEndHM) {
            var sp = startInput.value.split(":");
            var ns = new Date(origSD);
            ns.setHours(parseInt(sp[0]), parseInt(sp[1]), 0, 0);
            var ep = endInput.value.split(":");
            var ne = new Date(origED);
            ne.setHours(parseInt(ep[0]), parseInt(ep[1]), 0, 0);
            var durSecs = Math.round((ne.getTime() - ns.getTime()) / 1000);
            if (durSecs < 0) durSecs += 86400;
            viewerTimeSaveCallback(ns.toISOString(), ne.toISOString(), durSecs);
            viewerOriginalStartISO = ns.toISOString();
            viewerOriginalEndISO = ne.toISOString();
          }
        }
        viewerOriginalCategory = newCategory;
        if (typeChanged) viewerOriginalType = newType;
        return;
      }

      if (!viewerRecordId) return;
      if (saveBtn) saveBtn.disabled = true;

      var fn = viewerRecordType === "interruption"
        ? "updateInterruptionNote"
        : "updateRecordDescription";

      var promises = [serverCall(fn, viewerRecordId, markdown)];

      if (categoryChanged) {
        var catFn = viewerRecordType === "interruption"
          ? "updateInterruptionCategory"
          : "updateRecordCategory";
        promises.push(serverCall(catFn, viewerRecordId, newCategory));

        // Ensure category exists
        var ensureFn = viewerSheetType === "InterruptionCategories"
          ? App.ensureInterruptionCategory
          : RecordForm.ensureCategory;
        if (ensureFn) promises.push(ensureFn(newCategory));
      }

      if (typeChanged) {
        promises.push(serverCall("updateInterruptionType", viewerRecordId, newType));
      }

      // Check if times changed (only send changed fields)
      var startChanged = false;
      var endChanged = false;
      var newStartISO = null;
      var newEndISO = null;
      if (viewerOriginalStartISO && viewerOriginalEndISO) {
        var startInput = document.getElementById("viewer-start-time");
        var endInput = document.getElementById("viewer-end-time");
        var origSD = new Date(viewerOriginalStartISO);
        var origED = new Date(viewerOriginalEndISO);
        var origStartHM = String(origSD.getHours()).padStart(2, "0") + ":" + String(origSD.getMinutes()).padStart(2, "0");
        var origEndHM = String(origED.getHours()).padStart(2, "0") + ":" + String(origED.getMinutes()).padStart(2, "0");
        if (startInput.value !== origStartHM) {
          startChanged = true;
          var sp = startInput.value.split(":");
          var ns = new Date(origSD);
          ns.setHours(parseInt(sp[0]), parseInt(sp[1]), 0, 0);
          newStartISO = ns.toISOString();
        }
        if (endInput.value !== origEndHM) {
          endChanged = true;
          var ep = endInput.value.split(":");
          var ne = new Date(origED);
          ne.setHours(parseInt(ep[0]), parseInt(ep[1]), 0, 0);
          newEndISO = ne.toISOString();
        }
        if (startChanged || endChanged) {
          var timeFn = viewerRecordType === "interruption"
            ? "updateInterruptionTimes"
            : "updateRecordTimes";
          promises.push(serverCall(timeFn, viewerRecordId, newStartISO, newEndISO));
        }
      }

      Promise.all(promises)
        .then(function () {
          if (saveBtn) saveBtn.disabled = false;
          viewerOriginalCategory = newCategory;
          if (typeChanged) viewerOriginalType = newType;
          if (startChanged) viewerOriginalStartISO = newStartISO;
          if (endChanged) viewerOriginalEndISO = newEndISO;
          refreshAll();
        })
        .catch(function (err) {
          if (saveBtn) saveBtn.disabled = false;
          alert("保存に失敗しました: " + err);
        });
    }

    function hideViewer() {
      var viewerBtn = document.querySelector('.tab-btn[data-tab="viewer"]');
      if (viewerBtn) viewerBtn.style.display = "none";
      viewerOpen = false;

      MemoEditor.clearViewer();

      // Fall back to memo tab
      switchTab("memo");
    }

    function showSettings() {
      var settingsBtn = document.querySelector('.tab-btn[data-tab="settings"]');
      if (settingsBtn) settingsBtn.style.display = "";
      settingsOpen = true;
      switchTab("settings");
    }

    function hideSettings() {
      var settingsBtn = document.querySelector('.tab-btn[data-tab="settings"]');
      if (settingsBtn) settingsBtn.style.display = "none";
      settingsOpen = false;
      switchTab("memo");
      // Refresh app state with updated configs/categories
      App.refreshSettings();
    }

    function update(phase) {
      var visibility = tabVisibility[phase] || tabVisibility.idle;

      // Show/hide tab buttons (viewer is managed separately)
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        var tabId = btn.getAttribute("data-tab");
        if (tabId === "viewer") {
          btn.style.display = viewerOpen ? "" : "none";
          return;
        }
        if (tabId === "settings") {
          btn.style.display = settingsOpen ? "" : "none";
          return;
        }
        btn.style.display = visibility[tabId] ? "" : "none";
      });

      // Auto-switch tab on phase change
      if (phase !== lastAutoPhase) {
        // Don't auto-switch if settings is open
        if (activeTab !== "settings") {
          var target = autoSwitchTarget[phase] || "memo";
          if (visibility[target]) {
            switchTab(target);
          } else {
            switchTab("memo");
          }
        }
        lastAutoPhase = phase;
      } else {
        if (activeTab !== "viewer" && activeTab !== "settings" && !visibility[activeTab]) {
          switchTab("memo");
        }
      }
    }

    function getActiveTab() {
      return activeTab;
    }

    return {
      init: init,
      switchTab: switchTab,
      update: update,
      getActiveTab: getActiveTab,
      showViewer: showViewer,
      hideViewer: hideViewer,
      saveViewer: saveViewer,
      showSettings: showSettings,
      hideSettings: hideSettings,
    };
  })();
</script>
