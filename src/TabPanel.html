<script>
  var TabPanel = (function () {
    var activeTab = "memo";
    var lastAutoPhase = null;

    // Which tabs are visible per phase
    var tabVisibility = {
      idle: { memo: true, record: false, interruption: false },
      work: { memo: true, record: true, interruption: false },
      interrupted: { memo: true, record: true, interruption: true },
      shortBreak: { memo: true, record: false, interruption: false },
      longBreak: { memo: true, record: false, interruption: false },
      breakDone: { memo: true, record: false, interruption: false },
    };

    // Auto-switch target when entering a new phase
    var autoSwitchTarget = {
      idle: "memo",
      work: "record",
      interrupted: "interruption",
      shortBreak: "memo",
      longBreak: "memo",
      breakDone: "memo",
    };

    function init() {
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          var tabId = btn.getAttribute("data-tab");
          switchTab(tabId);
        });
      });
    }

    function switchTab(tabId) {
      // Deactivate all
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        btn.classList.remove("active");
      });
      var contents = document.querySelectorAll(".tab-content");
      contents.forEach(function (c) {
        c.style.display = "none";
        c.classList.remove("active");
      });

      // Activate target
      var targetBtn = document.querySelector(
        '.tab-btn[data-tab="' + tabId + '"]',
      );
      if (targetBtn) targetBtn.classList.add("active");
      var targetContent = document.querySelector(
        '.tab-content[data-tab-content="' + tabId + '"]',
      );
      if (targetContent) {
        targetContent.style.display = "flex";
        targetContent.classList.add("active");
      }

      activeTab = tabId;
    }

    var viewerOpen = false;
    var viewerRecordId = null;   // record or interruption ID
    var viewerRecordType = null; // "record" or "interruption"
    var viewerSaveCallback = null; // optional callback for in-memory save
    var viewerCategorySaveCallback = null; // optional callback for in-memory category save
    var viewerSheetType = null;  // "Categories" or "InterruptionCategories"
    var viewerOriginalCategory = ""; // track original category for change detection
    var viewerCombo = null;
    var viewerOriginalType = null; // "work" or "nonWork", null if not interruption
    var viewerTypeSaveCallback = null; // optional callback for in-memory type save

    function initViewerCombo() {
      if (viewerCombo) return;
      viewerCombo = CategoryCombo.create({
        inputId: "viewer-category",
        categories: [],
        sheetType: "Categories",
        onSelect: function () {},
      });
    }

    function showViewer(title, meta, markdown, recordId, recordType, saveCallbackOrOpts) {
      initViewerCombo();

      // Show viewer tab button
      var viewerBtn = document.querySelector('.tab-btn[data-tab="viewer"]');
      if (viewerBtn) viewerBtn.style.display = "";
      viewerOpen = true;
      viewerRecordId = recordId || null;
      viewerRecordType = recordType || null;
      viewerSaveCallback = null;
      viewerCategorySaveCallback = null;
      viewerTypeSaveCallback = null;
      viewerSheetType = null;
      viewerOriginalCategory = "";
      viewerOriginalType = null;

      // Parse opts (6th argument)
      var opts = {};
      if (typeof saveCallbackOrOpts === "function") {
        viewerSaveCallback = saveCallbackOrOpts;
      } else if (saveCallbackOrOpts && typeof saveCallbackOrOpts === "object") {
        opts = saveCallbackOrOpts;
        viewerSaveCallback = opts.saveCallback || null;
        viewerCategorySaveCallback = opts.categorySaveCallback || null;
        viewerTypeSaveCallback = opts.typeSaveCallback || null;
      }

      // Category setup
      var category = opts.category || "";
      viewerSheetType = opts.sheetType || null;
      viewerOriginalCategory = category;

      if (viewerSheetType) {
        var state = App.getState();
        var cats = viewerSheetType === "InterruptionCategories"
          ? state.interruptionCategories
          : state.categories;
        viewerCombo.setSheetType(viewerSheetType);
        viewerCombo.setCategories(cats);
        viewerCombo.setValue(category);
        document.getElementById("viewer-category").parentNode.style.display = "";
      } else {
        viewerCombo.setValue("");
        document.getElementById("viewer-category").parentNode.style.display = "none";
      }

      // Interruption type toggle
      var typeLabel = document.getElementById("viewer-type-label");
      var typeCheckbox = document.getElementById("viewer-type-work");
      if (opts.interruptionType) {
        viewerOriginalType = opts.interruptionType;
        typeCheckbox.checked = opts.interruptionType === "work";
        typeLabel.style.display = "";
      } else {
        typeLabel.style.display = "none";
      }

      // Set header content
      document.getElementById("viewer-title").textContent = title || "";
      document.getElementById("viewer-meta").textContent = meta || "";

      // Show/hide save button based on whether we have a record to save to
      var saveBtn = document.getElementById("viewer-save-btn");
      if (saveBtn) saveBtn.style.display = (viewerRecordId || viewerSaveCallback) ? "" : "none";

      // Set editor content
      MemoEditor.setViewerValue(markdown || "");

      // Switch to viewer tab
      switchTab("viewer");
    }

    function getViewerType() {
      var typeCheckbox = document.getElementById("viewer-type-work");
      return typeCheckbox && typeCheckbox.checked ? "work" : "nonWork";
    }

    function saveViewer() {
      var markdown = MemoEditor.getViewerValue();
      var saveBtn = document.getElementById("viewer-save-btn");
      var newCategory = viewerCombo ? viewerCombo.getValue() : "";
      var categoryChanged = viewerSheetType && newCategory !== viewerOriginalCategory;
      var newType = viewerOriginalType ? getViewerType() : null;
      var typeChanged = newType && newType !== viewerOriginalType;

      // In-memory save (e.g. unsaved interruption notes)
      if (viewerSaveCallback) {
        viewerSaveCallback(markdown);
        if (viewerCategorySaveCallback && categoryChanged) {
          viewerCategorySaveCallback(newCategory);
        }
        if (viewerTypeSaveCallback && typeChanged) {
          viewerTypeSaveCallback(newType);
        }
        viewerOriginalCategory = newCategory;
        if (typeChanged) viewerOriginalType = newType;
        return;
      }

      if (!viewerRecordId) return;
      if (saveBtn) saveBtn.disabled = true;

      var fn = viewerRecordType === "interruption"
        ? "updateInterruptionNote"
        : "updateRecordDescription";

      var promises = [serverCall(fn, viewerRecordId, markdown)];

      if (categoryChanged) {
        var catFn = viewerRecordType === "interruption"
          ? "updateInterruptionCategory"
          : "updateRecordCategory";
        promises.push(serverCall(catFn, viewerRecordId, newCategory));

        // Ensure category exists
        var ensureFn = viewerSheetType === "InterruptionCategories"
          ? App.ensureInterruptionCategory
          : RecordForm.ensureCategory;
        if (ensureFn) promises.push(ensureFn(newCategory));
      }

      if (typeChanged) {
        promises.push(serverCall("updateInterruptionType", viewerRecordId, newType));
      }

      Promise.all(promises)
        .then(function () {
          if (saveBtn) saveBtn.disabled = false;
          viewerOriginalCategory = newCategory;
          if (typeChanged) viewerOriginalType = newType;
          refreshAll();
        })
        .catch(function (err) {
          if (saveBtn) saveBtn.disabled = false;
          alert("保存に失敗しました: " + err);
        });
    }

    function hideViewer() {
      var viewerBtn = document.querySelector('.tab-btn[data-tab="viewer"]');
      if (viewerBtn) viewerBtn.style.display = "none";
      viewerOpen = false;

      MemoEditor.clearViewer();

      // Fall back to memo tab
      switchTab("memo");
    }

    function update(phase) {
      var visibility = tabVisibility[phase] || tabVisibility.idle;

      // Show/hide tab buttons (viewer is managed separately)
      var buttons = document.querySelectorAll(".tab-btn");
      buttons.forEach(function (btn) {
        var tabId = btn.getAttribute("data-tab");
        if (tabId === "viewer") {
          // Viewer tab visibility is managed by showViewer/hideViewer
          btn.style.display = viewerOpen ? "" : "none";
          return;
        }
        btn.style.display = visibility[tabId] ? "" : "none";
      });

      // Auto-switch tab on phase change
      if (phase !== lastAutoPhase) {
        var target = autoSwitchTarget[phase] || "memo";
        // Only auto-switch if the target tab is visible
        if (visibility[target]) {
          switchTab(target);
        } else {
          switchTab("memo");
        }
        lastAutoPhase = phase;
      } else {
        // If current tab became invisible (and not viewer), fall back to memo
        if (activeTab !== "viewer" && !visibility[activeTab]) {
          switchTab("memo");
        }
      }
    }

    function getActiveTab() {
      return activeTab;
    }

    return {
      init: init,
      switchTab: switchTab,
      update: update,
      getActiveTab: getActiveTab,
      showViewer: showViewer,
      hideViewer: hideViewer,
      saveViewer: saveViewer,
    };
  })();
</script>
